{"remainingRequest":"C:\\Users\\gio\\Desktop\\work\\liveness\\liveness-detection\\client\\node_modules\\thread-loader\\dist\\cjs.js!C:\\Users\\gio\\Desktop\\work\\liveness\\liveness-detection\\client\\node_modules\\babel-loader\\lib\\index.js!C:\\Users\\gio\\Desktop\\work\\liveness\\liveness-detection\\client\\node_modules\\ts-loader\\index.js??ref--14-3!C:\\Users\\gio\\Desktop\\work\\liveness\\liveness-detection\\client\\node_modules\\eslint-loader\\index.js??ref--13-0!C:\\Users\\gio\\Desktop\\work\\liveness\\liveness-detection\\client\\src\\js\\StateManager.ts","dependencies":[{"path":"C:\\Users\\gio\\Desktop\\work\\liveness\\liveness-detection\\client\\src\\js\\StateManager.ts","mtime":1632856214376},{"path":"C:\\Users\\gio\\Desktop\\work\\liveness\\liveness-detection\\client\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\gio\\Desktop\\work\\liveness\\liveness-detection\\client\\node_modules\\thread-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\gio\\Desktop\\work\\liveness\\liveness-detection\\client\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000},{"path":"C:\\Users\\gio\\Desktop\\work\\liveness\\liveness-detection\\client\\node_modules\\ts-loader\\index.js","mtime":499162500000},{"path":"C:\\Users\\gio\\Desktop\\work\\liveness\\liveness-detection\\client\\node_modules\\eslint-loader\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9jbGFzc0NhbGxDaGVjayBmcm9tICJDOi9Vc2Vycy9naW8vRGVza3RvcC93b3JrL2xpdmVuZXNzL2xpdmVuZXNzLWRldGVjdGlvbi9jbGllbnQvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2NsYXNzQ2FsbENoZWNrIjsKaW1wb3J0IF9jcmVhdGVDbGFzcyBmcm9tICJDOi9Vc2Vycy9naW8vRGVza3RvcC93b3JrL2xpdmVuZXNzL2xpdmVuZXNzLWRldGVjdGlvbi9jbGllbnQvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2NyZWF0ZUNsYXNzIjsKLy8gQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQtMAppbXBvcnQgTG9nZ2VyIGZyb20gImpzLWxvZ2dlciI7CmltcG9ydCB7IEZhY2VTdGF0ZSB9IGZyb20gIkAvanMvU3RhdGVzLnRzIjsKaW1wb3J0IHsgRmFpbFN0YXRlIH0gZnJvbSAiQC9qcy9TdGF0ZXMudHMiOwppbXBvcnQgeyBOb3NlU3RhdGUgfSBmcm9tICJAL2pzL1N0YXRlcy50cyI7CmltcG9ydCB7IFN1Y2Nlc3NTdGF0ZSB9IGZyb20gIkAvanMvU3RhdGVzLnRzIjsKZXhwb3J0IHZhciBTdGF0ZU1hbmFnZXIgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFN0YXRlTWFuYWdlcihjaGFsbGVuZ2VEZXRhaWxzKSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgU3RhdGVNYW5hZ2VyKTsKCiAgICB0aGlzLmNoYWxsZW5nZURldGFpbHMgPSBjaGFsbGVuZ2VEZXRhaWxzOwogICAgdGhpcy5jaGFuZ2VDdXJyZW50U3RhdGUobmV3IEZhY2VTdGF0ZSh0aGlzLmNoYWxsZW5nZURldGFpbHMpKTsKICB9CgogIF9jcmVhdGVDbGFzcyhTdGF0ZU1hbmFnZXIsIFt7CiAgICBrZXk6ICJwcm9jZXNzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBwcm9jZXNzKHJlc3VsdCkgewogICAgICBMb2dnZXIuZGVidWcoImN1cnJlbnQgc3RhdGU6ICIuY29uY2F0KHRoaXMuY3VycmVudFN0YXRlLmdldE5hbWUoKSkpOwoKICAgICAgaWYgKHRoaXMuZW5kVGltZSA+IDAgJiYgRGF0ZS5ub3coKSAvIDEwMDAgPiB0aGlzLmVuZFRpbWUpIHsKICAgICAgICBMb2dnZXIuaW5mbygiZmFpbDogc3RhdGUgdGltZWQgb3V0Iik7CiAgICAgICAgdGhpcy5jaGFuZ2VDdXJyZW50U3RhdGUobmV3IEZhaWxTdGF0ZSh0aGlzLmNoYWxsZW5nZURldGFpbHMpKTsKICAgICAgfQoKICAgICAgdmFyIHN0YXRlT3V0cHV0ID0gdGhpcy5jdXJyZW50U3RhdGUucHJvY2VzcyhyZXN1bHQpOwoKICAgICAgaWYgKHN0YXRlT3V0cHV0Lm5leHRTdGF0ZSkgewogICAgICAgIHRoaXMuY2hhbmdlQ3VycmVudFN0YXRlKHN0YXRlT3V0cHV0Lm5leHRTdGF0ZSk7CiAgICAgIH0KCiAgICAgIHZhciBlbmQgPSBmYWxzZTsKICAgICAgdmFyIHNob3VsZFNhdmVGcmFtZSA9IGZhbHNlOwogICAgICB2YXIgc3VjY2VzczsKCiAgICAgIGlmICh0aGlzLmN1cnJlbnRTdGF0ZS5nZXROYW1lKCkgPT09IFN1Y2Nlc3NTdGF0ZS5OQU1FKSB7CiAgICAgICAgZW5kID0gdHJ1ZTsKICAgICAgICBzdWNjZXNzID0gdHJ1ZTsKICAgICAgICBzaG91bGRTYXZlRnJhbWUgPSB0cnVlOwogICAgICB9IGVsc2UgaWYgKHRoaXMuY3VycmVudFN0YXRlLmdldE5hbWUoKSA9PT0gRmFpbFN0YXRlLk5BTUUpIHsKICAgICAgICBlbmQgPSB0cnVlOwogICAgICAgIHN1Y2Nlc3MgPSBmYWxzZTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmN1cnJlbnRTdGF0ZS5nZXROYW1lKCkgPT09IE5vc2VTdGF0ZS5OQU1FKSB7CiAgICAgICAgc2hvdWxkU2F2ZUZyYW1lID0gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICBlbmQ6IGVuZCwKICAgICAgICBzdWNjZXNzOiBzdWNjZXNzLAogICAgICAgIHNob3VsZFNhdmVGcmFtZTogc2hvdWxkU2F2ZUZyYW1lLAogICAgICAgIGRyYXdPcHRpb25zOiBzdGF0ZU91dHB1dC5kcmF3T3B0aW9ucywKICAgICAgICBoZWxwTWVzc2FnZTogc3RhdGVPdXRwdXQuaGVscE1lc3NhZ2UsCiAgICAgICAgaGVscEFuaW1hdGlvbk51bWJlcjogc3RhdGVPdXRwdXQuaGVscEFuaW1hdGlvbk51bWJlcgogICAgICB9OwogICAgfQogIH0sIHsKICAgIGtleTogImNoYW5nZUN1cnJlbnRTdGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY2hhbmdlQ3VycmVudFN0YXRlKHN0YXRlKSB7CiAgICAgIGlmICh0aGlzLmN1cnJlbnRTdGF0ZSAhPT0gc3RhdGUpIHsKICAgICAgICB0aGlzLmN1cnJlbnRTdGF0ZSA9IHN0YXRlOwogICAgICAgIHRoaXMuZW5kVGltZSA9IHN0YXRlLmdldE1heGltdW1EdXJhdGlvbkluU2Vjb25kcygpICE9IC0xID8gRGF0ZS5ub3coKSAvIDEwMDAgKyBzdGF0ZS5nZXRNYXhpbXVtRHVyYXRpb25JblNlY29uZHMoKSA6IC0xOwogICAgICB9CiAgICB9CiAgfV0pOwoKICByZXR1cm4gU3RhdGVNYW5hZ2VyOwp9KCk7"},{"version":3,"sources":["C:\\Users\\gio\\Desktop\\work\\liveness\\liveness-detection\\client\\node_modules\\eslint-loader\\index.js??ref--13-0!C:\\Users\\gio\\Desktop\\work\\liveness\\liveness-detection\\client\\src\\js\\StateManager.ts"],"names":[],"mappings":";;AAAA;AACA;AAGA,OAAO,MAAP,MAAmB,WAAnB;AAGA,SAAS,SAAT,QAA0B,gBAA1B;AACA,SAAS,SAAT,QAA0B,gBAA1B;AACA,SAAS,SAAT,QAA0B,gBAA1B;AAGA,SAAS,YAAT,QAA6B,gBAA7B;AAWA,WAAa,YAAb;AAME,wBAAY,gBAAZ,EAA8C;AAAA;;AAC5C,SAAK,gBAAL,GAAwB,gBAAxB;AACA,SAAK,kBAAL,CAAwB,IAAI,SAAJ,CAAc,KAAK,gBAAnB,CAAxB;AACD;;AATH;AAAA;AAAA,WAWE,iBACE,MADF,EACoG;AAElG,MAAA,MAAM,CAAC,KAAP,0BAA+B,KAAK,YAAL,CAAkB,OAAlB,EAA/B;;AAEA,UAAI,KAAK,OAAL,GAAe,CAAf,IAAoB,IAAI,CAAC,GAAL,KAAa,IAAb,GAAoB,KAAK,OAAjD,EAA0D;AACxD,QAAA,MAAM,CAAC,IAAP;AACA,aAAK,kBAAL,CAAwB,IAAI,SAAJ,CAAc,KAAK,gBAAnB,CAAxB;AACD;;AACD,UAAM,WAAW,GAAgB,KAAK,YAAL,CAAkB,OAAlB,CAA0B,MAA1B,CAAjC;;AACA,UAAI,WAAW,CAAC,SAAhB,EAA2B;AACzB,aAAK,kBAAL,CAAwB,WAAW,CAAC,SAApC;AACD;;AAED,UAAI,GAAG,GAAG,KAAV;AACA,UAAI,eAAe,GAAG,KAAtB;AACA,UAAI,OAAJ;;AACA,UAAI,KAAK,YAAL,CAAkB,OAAlB,OAAgC,YAAY,CAAC,IAAjD,EAAuD;AACrD,QAAA,GAAG,GAAG,IAAN;AACA,QAAA,OAAO,GAAG,IAAV;AACA,QAAA,eAAe,GAAG,IAAlB;AACD,OAJD,MAIO,IAAI,KAAK,YAAL,CAAkB,OAAlB,OAAgC,SAAS,CAAC,IAA9C,EAAoD;AACzD,QAAA,GAAG,GAAG,IAAN;AACA,QAAA,OAAO,GAAG,KAAV;AACD,OAHM,MAGA,IAAI,KAAK,YAAL,CAAkB,OAAlB,OAAgC,SAAS,CAAC,IAA9C,EAAoD;AACzD,QAAA,eAAe,GAAG,IAAlB;AACD;;AACD,aAAO;AACL,QAAA,GAAG,EAAE,GADA;AAEL,QAAA,OAAO,EAAE,OAFJ;AAGL,QAAA,eAAe,EAAE,eAHZ;AAIL,QAAA,WAAW,EAAE,WAAW,CAAC,WAJpB;AAKL,QAAA,WAAW,EAAE,WAAW,CAAC,WALpB;AAML,QAAA,mBAAmB,EAAE,WAAW,CAAC;AAN5B,OAAP;AAQD;AA9CH;AAAA;AAAA,WAgDU,4BAAmB,KAAnB,EAA+B;AACrC,UAAI,KAAK,YAAL,KAAsB,KAA1B,EAAiC;AAC/B,aAAK,YAAL,GAAoB,KAApB;AACA,aAAK,OAAL,GACE,KAAK,CAAC,2BAAN,MAAuC,CAAC,CAAxC,GAA4C,IAAI,CAAC,GAAL,KAAa,IAAb,GAAoB,KAAK,CAAC,2BAAN,EAAhE,GAAsG,CAAC,CADzG;AAED;AACF;AAtDH;;AAAA;AAAA","sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\r\n// SPDX-License-Identifier: MIT-0\r\n\r\nimport * as faceapi from \"face-api.js\";\r\nimport Logger from \"js-logger\";\r\nimport { ChallengeDetails } from \"@/js/RemoteStarter.ts\";\r\nimport { DrawOptions } from \"@/js/Drawer.ts\";\r\nimport { FaceState } from \"@/js/States.ts\";\r\nimport { FailState } from \"@/js/States.ts\";\r\nimport { NoseState } from \"@/js/States.ts\";\r\nimport { State } from \"@/js/States.ts\";\r\nimport { StateOutput } from \"@/js/States.ts\";\r\nimport { SuccessState } from \"@/js/States.ts\";\r\n\r\nexport interface StateManagerOutput {\r\n  readonly end: boolean;\r\n  readonly success?: boolean;\r\n  readonly shouldSaveFrame: boolean;\r\n  readonly drawOptions?: DrawOptions;\r\n  readonly helpMessage?: string;\r\n  readonly helpAnimationNumber?: number;\r\n}\r\n\r\nexport class StateManager {\r\n  private readonly challengeDetails: ChallengeDetails;\r\n\r\n  private currentState!: State;\r\n  private endTime!: number;\r\n\r\n  constructor(challengeDetails: ChallengeDetails) {\r\n    this.challengeDetails = challengeDetails;\r\n    this.changeCurrentState(new FaceState(this.challengeDetails));\r\n  }\r\n\r\n  process(\r\n    result: faceapi.WithFaceLandmarks<{ detection: faceapi.FaceDetection }, faceapi.FaceLandmarks68>[]\r\n  ): StateManagerOutput {\r\n    Logger.debug(`current state: ${this.currentState.getName()}`);\r\n\r\n    if (this.endTime > 0 && Date.now() / 1000 > this.endTime) {\r\n      Logger.info(`fail: state timed out`);\r\n      this.changeCurrentState(new FailState(this.challengeDetails));\r\n    }\r\n    const stateOutput: StateOutput = this.currentState.process(result);\r\n    if (stateOutput.nextState) {\r\n      this.changeCurrentState(stateOutput.nextState);\r\n    }\r\n\r\n    let end = false;\r\n    let shouldSaveFrame = false;\r\n    let success;\r\n    if (this.currentState.getName() === SuccessState.NAME) {\r\n      end = true;\r\n      success = true;\r\n      shouldSaveFrame = true;\r\n    } else if (this.currentState.getName() === FailState.NAME) {\r\n      end = true;\r\n      success = false;\r\n    } else if (this.currentState.getName() === NoseState.NAME) {\r\n      shouldSaveFrame = true;\r\n    }\r\n    return {\r\n      end: end,\r\n      success: success,\r\n      shouldSaveFrame: shouldSaveFrame,\r\n      drawOptions: stateOutput.drawOptions,\r\n      helpMessage: stateOutput.helpMessage,\r\n      helpAnimationNumber: stateOutput.helpAnimationNumber\r\n    };\r\n  }\r\n\r\n  private changeCurrentState(state: State) {\r\n    if (this.currentState !== state) {\r\n      this.currentState = state;\r\n      this.endTime =\r\n        state.getMaximumDurationInSeconds() != -1 ? Date.now() / 1000 + state.getMaximumDurationInSeconds() : -1;\r\n    }\r\n  }\r\n}\r\n"],"sourceRoot":""}]}